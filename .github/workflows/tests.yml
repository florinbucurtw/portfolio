name: Automation Tests

on:
  push:
    branches:
      - automation
  pull_request:
    branches:
      - automation

jobs:
  api-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Firebase Tools
        run: npm i -g firebase-tools
      - name: Install dependencies
        run: npm ci
      - name: Start Firebase Emulators
        run: |
          npm --prefix functions ci
          nohup npx --prefix functions firebase emulators:start &
          # wait for emulator ports
          for i in {1..30}; do
            (nc -z 127.0.0.1 5001 && nc -z 127.0.0.1 8081) && break || sleep 2;
          done
        env:
          GOOGLE_CLOUD_PROJECT: florinportfolio
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8081
      - name: Seed Emulator
        run: npm run seed:emulator
        env:
          GOOGLE_CLOUD_PROJECT: florinportfolio
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8081
          API_BASE_OVERRIDE: http://127.0.0.1:5001/florinportfolio/europe-west1/api
      - name: Run API smoke test
        run: npx vitest run tests/api/health.spec.ts
        env:
          API_BASE_OVERRIDE: http://127.0.0.1:5001/florinportfolio/europe-west1/api
          GOOGLE_CLOUD_PROJECT: florinportfolio
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8081

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps
      - name: Start UI server
        run: |
          nohup npm run serve &
          # wait for UI to become ready
          for i in {1..30}; do
            curl -sSf http://localhost:3000 >/dev/null && break || sleep 2;
          done
      - name: Start Firebase Emulators
        run: |
          npm --prefix functions ci
          nohup npx --prefix functions firebase emulators:start &
          # wait for emulator ports
          for i in {1..30}; do
            (nc -z 127.0.0.1 5001 && nc -z 127.0.0.1 8081) && break || sleep 2;
          done
        env:
          GOOGLE_CLOUD_PROJECT: florinportfolio
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8081
      - name: Export local DB to backup JSON
        run: npm run export:db
      - name: Import backup into emulator
        run: npm run import:emulator
        env:
          GOOGLE_CLOUD_PROJECT: florinportfolio
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8081
      - name: Run Playwright smoke test
        env:
          UI_BASE_URL: http://localhost:3000
        run: npx playwright test tests/e2e/smoke.spec.ts
      - name: Seed Emulator for full E2E
        run: npm run seed:emulator
        env:
          GOOGLE_CLOUD_PROJECT: florinportfolio
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8081
          API_BASE_OVERRIDE: http://127.0.0.1:5001/florinportfolio/europe-west1/api
      - name: Run full Playwright E2E suite
        env:
          UI_BASE_URL: http://localhost:3000
          API_BASE_OVERRIDE: http://127.0.0.1:5001/florinportfolio/europe-west1/api
          GOOGLE_CLOUD_PROJECT: florinportfolio
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8081
        run: npx playwright test tests/e2e
